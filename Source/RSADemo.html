<html>

<body>

<div id="divUi">
	<label>RSA Encryption Demo</label>
	<p>
		Generate a key pair by clicking the Generate Key Pair button.
		Enter a message and click the Encrypt buttton to encrypt it.
		Then click the Decrypt button to Decrypt it.
	</p>

	<label>Digits per Prime:</label>
	<br />
	<input id="inputDigitsPerPrime" type="number" value="2"></input>

	<button onclick="buttonGenerateKeyPair_Clicked();">Generate</button>
	<br />

	<label>Public Key:</label>
	<br />
	<textarea id="textareaPublicKey" cols="40" rows="1"></textarea>
	<br />

	<label>Private Key:</label>
	<br />
	<textarea id="textareaPrivateKey" cols="40" rows="1"></textarea>
	<br />

	<label>Message to Encrypt:</label>
	<br />
	<textarea id="textareaMessageToEncrypt" cols="40" rows="10">RSA</textarea>
	<br />

	<button onclick="buttonEncrypt_Clicked();">Encrypt with Private Key</button>
	<br />

	<label>Message to Encrypt as Integer:</label>
	<br />
	<textarea id="textareaMessageToEncryptAsInteger" cols="40" rows="10"></textarea>
	<br />

	<label>Message Encrypted:</label>
	<br />
	<textarea id="textareaMessageEncrypted" cols="40" rows="10"></textarea>
	<br />

	<button onclick="buttonDecrypt_Clicked();">Decrypt with Public Key</button>
	<br />
	
	<label>Message Decrypted:</label>
	<br />
	<textarea id="textareaMessageDecrypted" cols="40" rows="10"></textarea>
	<br />
	
</div>

<script type="text/javascript" src="EncryptionKeyPair.js"></script>
<script type="text/javascript" src="LargeInteger.js"></script>
<script type="text/javascript" src="MathHelperLargeInteger.js"></script>

<script type="text/javascript">

// UI event handlers.

function buttonDecrypt_Clicked()
{
	var d = document;

	var textareaPublicKey = d.getElementById("textareaPublicKey");
	var textareaPrivateKey = d.getElementById("textareaPrivateKey");
	var textareaMessageToEncrypt =
		d.getElementById("textareaMessageToEncrypt");
	var textareaMessageEncrypted =
		d.getElementById("textareaMessageEncrypted");

	var keyPair = EncryptionKeyPair.fromJson
	(
		textareaPublicKey.value,
		textareaPrivateKey.value
	);

	var messageEncryptedAsString = textareaMessageEncrypted.value;
	var messageToEncryptAsLargeInteger =
		new LargeInteger(keyPair.modulus).parseFromString(messageEncryptedAsString);

	throw("todo");
}

function buttonEncrypt_Clicked()
{
	var d = document;

	var textareaPublicKey = d.getElementById("textareaPublicKey");
	var textareaPrivateKey = d.getElementById("textareaPrivateKey");
	var textareaMessageToEncrypt =
		d.getElementById("textareaMessageToEncrypt");
	var textareaMessageToEncryptAsInteger =
		d.getElementById("textareaMessageToEncryptAsInteger");
	var textareaMessageEncrypted =
		d.getElementById("textareaMessageEncrypted");

	var keyPair = EncryptionKeyPair.fromJson
	(
		textareaPublicKey.value,
		textareaPrivateKey.value
	);

	var messageToEncrypt = textareaMessageToEncrypt.value;
	var messageToEncryptAsLargeInteger =
		new LargeInteger(10);

	for (var i = 0; i < messageToEncrypt.length; i++)
	{
		var charToEncryptAsNumber = messageToEncrypt.charCodeAt(i);
		messageToEncryptAsLargeInteger.appendDigit(charToEncryptAsNumber);
	}

	textareaMessageToEncryptAsInteger.value =
		messageToEncryptAsLargeInteger.toString();

	var messageEncryptedAsLargeInteger =
		keyPair.encrypt(messageToEncryptAsLargeInteger);

	var messageEncryptedAsString =
		messageEncryptedAsLargeInteger.toString()

	textareaMessageEncrypted.value = messageEncryptedAsString;
}

function buttonGenerateKeyPair_Clicked()
{
	var d = document;

	var inputDigitsPerPrime = d.getElementById("inputDigitsPerPrime");
	var textareaPublicKey = d.getElementById("textareaPublicKey");
	var textareaPrivateKey = d.getElementById("textareaPrivateKey");

	var digitsPerPrime = parseInt(inputDigitsPerPrime.value);

	var keyPair = new EncryptionKeyPair().generate(digitsPerPrime);

	textareaPublicKey.value = keyPair.keyPublicAsJson();

	textareaPrivateKey.value = keyPair.keyPrivateAsJson();
}

function main()
{
	var newline = "<br />";

	// This implementation can't handle big numbers.
	var digitsPerPrime = 2;


	// hack
	// We're assuming the modulus is greater than the messageToEncrypt.
	// I believe this may cause problems on the rare occasions
	// when the modulus ends up being less than the message value.
 
	var messageToEncryptAsInt = 42;
	var base = keyPair.modulus.base;
	var messageToEncrypt = new LargeInteger(base).setFromInt
	(
		messageToEncryptAsInt
	);
	document.write
	(
		"Message to encrypt is "
		+ messageToEncrypt.toString()
		+ newline
	);
 
	var messageEncrypted = keyPair.encrypt(messageToEncrypt);
	document.write
	(
		"Message encrypted is "
		+ messageEncrypted.toString()
		+ newline
	);
 
	var messageDecrypted = keyPair.decrypt(messageEncrypted);
	document.write(
		"Message decrypted is "
		+ messageDecrypted.toString()
		+ newline
	);
}

</script>
</body>
</html>